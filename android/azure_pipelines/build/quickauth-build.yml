trigger:
  branches:
    include:
      - user/jingjinggu/*

jobs:
  - job: quick_auth_build
    displayName: Quick Auth Build Tasks
    cancelTimeoutInMinutes: 1
    steps:
      - checkout: self
        clean: true
        submodules: recursive
        persistCredentials: True
      - task: Gradle@1
        name: Gradle3
        displayName: Assemble Release
        inputs:
          gradleWrapperFile: android/gradlew
          workingDirectory: 'android'
          tasks: quick_auth:clean quick_auth:assemble
          publishJUnitResults: false
          jdkArchitecture: x86
          sqAnalysisBreakBuildIfQualityGateFailed: false

  - job: quick_auth_unit_test
    displayName: Quick Auth Unit Test Tasks
    cancelTimeoutInMinutes: 1
    steps:
      - checkout: self
        clean: true
        submodules: recursive
        persistCredentials: True
      - task: Gradle@2
        name: Gradle3
        displayName: Run Unit Test
        inputs:
          gradleWrapperFile: android/gradlew
          workingDirectory: 'android'
          tasks: quick_auth:clean quick_auth:testDebugUnitTest
          publishJUnitResults: false
          jdkArchitecture: x86
          sqAnalysisBreakBuildIfQualityGateFailed: false
      - task: CopyFiles@2
        displayName: 'Copy unit-test result to Artifact Staging Directory'
        inputs:
          SourceFolder: android/quick_auth/build/reports/tests/
          Contents: '**/*.*'
          TargetFolder: $(Build.ArtifactStagingDirectory)

  - job: quick_auth_instrumentation_test
    displayName: Quick Auth Instrumentation Test Tasks
    cancelTimeoutInMinutes: 1
    steps:
      - checkout: self
        clean: true
        submodules: recursive
        persistCredentials: True
      - task: Gradle@3
        name: Gradle3
        displayName: Assemble Release
        inputs:
          gradleWrapperFile: android/gradlew
          workingDirectory: 'android'
          tasks: quick_auth:clean quick_auth:assemble
          publishJUnitResults: false
          jdkArchitecture: x86
          sqAnalysisBreakBuildIfQualityGateFailed: false
      - task: Bash@3
        displayName: 'Install Android Emulator'
        inputs:
          targetType: 'inline'
          script: |
            # Install AVD files
            echo "y" | $ANDROID_HOME/tools/bin/sdkmanager --install 'system-images;android-27;google_apis;x86'

            # Create emulator
            echo "no" | $ANDROID_HOME/tools/bin/avdmanager create avd -n xamarin_android_emulator -k 'system-images;android-27;google_apis;x86' --force

            $ANDROID_HOME/emulator/emulator -list-avds

            echo "Starting emulator"

            # Start emulator in background
            nohup $ANDROID_HOME/emulator/emulator -avd xamarin_android_emulator -no-snapshot > /dev/null 2>&1 &
            $ANDROID_HOME/platform-tools/adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed | tr -d '\r') ]]; do sleep 1; done; input keyevent 82'

            $ANDROID_HOME/platform-tools/adb devices

            echo "Emulator started"
      - task: Gradle@4
        name: Gradle3
        displayName: Run Instrumentation Test
        inputs:
          gradleWrapperFile: android/gradlew
          workingDirectory: 'android'
          tasks: quick_auth:clean quick_auth:connectedCheck
          publishJUnitResults: false
          jdkArchitecture: x86
          sqAnalysisBreakBuildIfQualityGateFailed: false
      - task: CopyFiles@2
        displayName: 'Copy instrumentation-test result to Artifact Staging Directory'
        inputs:
          SourceFolder: android/quick_auth/build/reports/androidTests/
          Contents: '**/*.*'
          TargetFolder: $(Build.ArtifactStagingDirectory)
